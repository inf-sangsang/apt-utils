<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인구 통계 대시보드</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Nanum+Gothic:wght@400;700;800&family=Noto+Serif+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>📊 인구 통계 대시보드</h1>
            <div class="subtitle" id="subtitle">행정구역별 인구 현황</div>
            <div style="margin-top: 20px; text-align: center;">
                <label for="fontSelect" style="color: #5a6c7d; font-weight: 500; margin-right: 10px;">폰트 선택:</label>
                <select id="fontSelect"
                    style="padding: 8px 15px; border: 2px solid #d0dce8; border-radius: 6px; font-size: 0.9em; background: white; cursor: pointer;">
                    <option value="Noto Sans KR" selected>Noto Sans KR</option>
                    <option value="Nanum Gothic">나눔고딕</option>
                    <option value="Noto Serif KR">Noto Serif KR</option>
                    <option value="old_studio1">a옛날사진관1</option>
                    <option value="old_studio2">a옛날사진관2</option>
                    <option value="old_studio3">a옛날사진관3</option>
                    <option value="old_studio4">a옛날사진관4</option>
                    <option value="old_studio5">a옛날사진관5</option>
                    <option value="esamanru_light">이사만루 light</option>
                    <option value="esamanru_medium">이사만루 medium</option>
                    <option value="esamanru_bold">이사만루 bold</option>
                </select>
            </div>
        </header>

        <div class="control-panel">
            <div class="filter-section">
                <h3>📅 데이터 기준월</h3>
                <div class="sort-section">
                    <label for="dateSelect">기준월 선택:</label>
                    <select id="dateSelect">
                        <option value="202511" selected>2025년 11월</option>
                        <option value="202510">2025년 10월</option>
                        <option value="202509">2025년 09월</option>
                        <option value="202508">2025년 08월</option>
                        <option value="202507">2025년 07월</option>
                        <option value="202506">2025년 06월</option>
                        <option value="202505">2025년 05월</option>
                    </select>
                </div>

                <h3>🗺️ 행정구역 선택</h3>
                <div class="region-buttons">
                    <button class="region-btn active" data-level="1">시/도</button>
                    <button class="region-btn" data-level="2">시/군/구</button>
                </div>

                <div class="search-container">
                    <input type="text" id="regionSearch" placeholder="지역 검색...">
                    <div id="dropdownList" class="dropdown-list"></div>
                </div>

                <div id="statsGrid" class="stats-grid"></div>
            </div>

            <div class="chart-container">
                <h2>🏘️ 인구 및 세대 현황</h2>
                <div class="sort-section">
                    <label for="householdSortSelect">정렬 기준:</label>
                    <select id="householdSortSelect">
                        <option value="name" selected>이름순</option>
                        <option value="population">총인구수</option>
                        <option value="households">세대수</option>
                        <option value="avgSize">세대당 인구</option>
                    </select>
                </div>
                <div class="chart-wrapper" style="height: 400px;">
                    <canvas id="householdChart"></canvas>
                </div>
            </div>

            <div>
                <div class="sort-section">
                    <label for="sortSelect">정렬 기준:</label>
                    <select id="sortSelect">
                        <option value="name" selected>이름순</option>
                        <option value="영유아">영유아</option>
                        <option value="10대">10대</option>
                        <option value="20대">20대</option>
                        <option value="30대">30대</option>
                        <option value="40대">40대</option>
                        <option value="50대">50대</option>
                        <option value="60대이상">60대이상</option>
                    </select>
                </div>
            </div>

            <div class="chart-container">
                <h2>📊 연령대별 인구 비율</h2>
                <div class="chart-wrapper">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>

            <!-- Age Group Comparison Section -->
            <div class="chart-container"
                style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 20px; background-color: #f9f9f9;">
                <h2 style="margin-top: 0;">📊 연령대별 비교 분석</h2>

                <div class="sort-section" style="margin-bottom: 20px;">
                    <label for="ageGroupSelect">연령대 그룹:</label>
                    <select id="ageGroupSelect">
                        <option value="default" selected>각 연령대별로 나누기</option>
                        <option value="group1">각 연령대 묶음1</option>
                        <option value="group2">각 연령대 묶음2</option>
                    </select>
                </div>

                <!-- Bar Chart -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #5a6c7d; margin-bottom: 10px;">📉 연령대별 비교 그래프</h3>
                    <div class="chart-wrapper" style="height: 400px;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- Age Group Chart -->
                <div>
                    <h3 style="color: #5a6c7d; margin-bottom: 10px;">📉 연령대별 행정구역 비교</h3>
                    <div class="chart-wrapper" style="height: 400px;">
                        <canvas id="ageGroupChart"></canvas>
                    </div>
                </div>
            </div>


            <div class="data-table">
                <h2 style="color: #5a6c7d; margin-bottom: 15px;">📋 상세 데이터</h2>
                <div id="tableContainer"></div>
            </div>
        </div>

        <!-- Initialize app and load data -->
        <script>
            // Define available dates manually as requested
            window.availableDates = ['202511', '202510', '202509', '202508', '202507', '202506', '202505'];

            // Default date
            let targetDate = '202511';

            // Check session storage for user selection
            const storedDate = sessionStorage.getItem('selectedDataDate');
            if (storedDate && window.availableDates.includes(storedDate)) {
                targetDate = storedDate;
            }

            // Set global currentDataDate for app.js to use
            window.currentDataDate = targetDate;

            // Update UI to reflect current date
            const dateSelect = document.getElementById('dateSelect');
            if (dateSelect) {
                dateSelect.value = targetDate;
            }

            // Format date for display
            const year = targetDate.substring(0, 4);
            const month = targetDate.substring(4, 6);
            const dateLabel = `${year}년 ${month}월`;

            document.getElementById('subtitle').textContent = `${dateLabel} 행정구역별 인구 현황`;
            document.title = `인구 통계 대시보드 - ${dateLabel}`;

            // Lazy load the specific data files for the selected date
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.body.appendChild(script);
                });
            }

            // Load data files first, then app logic
            Promise.all([
                loadScript(`data/csvData_${targetDate}_age.js`),
                loadScript(`data/csvData_${targetDate}_family.js`)
            ])
                .then(() => {
                    console.log(`Loaded data for ${targetDate}`);
                    // Load app scripts after data is ready
                    return loadScript('utils.js');
                })
                .then(() => loadScript('charts.js'))
                .then(() => loadScript('app.js'))
                .catch(error => {
                    console.error('Failed to load scripts:', error);
                    document.getElementById('tableContainer').innerHTML =
                        '<div class="no-data">데이터 파일을 로드하는 중 오류가 발생했습니다.<br>' +
                        '해당 월의 데이터 파일이 존재하는지 확인해주세요.</div>';
                });
        </script>
    </div>
</body>

</html>